<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portulu - Dashboard Ristoratore</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <div id="app" class="max-w-4xl mx-auto min-h-screen"></div>

  <script>
    const API_URL = 'https://portulu-api.onrender.com';
    
    let state = {
      view: 'orders',
      user: { name: 'Antica Trattoria Siciliana', id: 1 },
      orders: [],
      menuItems: [
        { id: 1, name: 'Pasta alla Norma', price: 12, category: 'Primi', available: true },
        { id: 2, name: 'Arancini Ragusani', price: 4, category: 'Antipasti', available: true },
        { id: 3, name: 'Caponata Siciliana', price: 8, category: 'Antipasti', available: true },
        { id: 4, name: 'Involtini di Pesce Spada', price: 16, category: 'Secondi', available: true },
        { id: 5, name: 'Cassata Siciliana', price: 6, category: 'Dolci', available: true },
        { id: 6, name: 'Cannolo Siciliano', price: 5, category: 'Dolci', available: false },
        { id: 7, name: 'Parmigiana di Melanzane', price: 10, category: 'Primi', available: true },
        { id: 8, name: 'Sarde a Beccafico', price: 14, category: 'Secondi', available: true }
      ],
      stats: {
        today: { orders: 12, revenue: 245.50 },
        week: { orders: 67, revenue: 1340.00 }
      },
      loading: false,
      editingItem: null
    };

    // Dati mock ordini
    const mockOrders = [
      {
        id: 1,
        order_number: 'ORD001',
        customer_name: 'Mario Rossi',
        customer_phone: '+39 333 1234567',
        delivery_address: 'Via Roma 45, Scicli Centro',
        delivery_zone: 'Scicli Centro',
        items: [
          { name: 'Pasta alla Norma', quantity: 2, price: 12 },
          { name: 'Arancini Ragusani', quantity: 3, price: 4 }
        ],
        total: 36,
        status: 'new',
        payment_method: 'Contanti',
        notes: 'Citofono al secondo piano',
        created_at: new Date().toISOString()
      },
      {
        id: 2,
        order_number: 'ORD002',
        customer_name: 'Giuseppe Battaglia',
        customer_phone: '+39 345 9876543',
        delivery_address: 'Lungomare Mediterraneo 12, Sampieri',
        delivery_zone: 'Sampieri',
        items: [
          { name: 'Caponata Siciliana', quantity: 1, price: 8 },
          { name: 'Involtini di Pesce Spada', quantity: 2, price: 16 },
          { name: 'Cassata Siciliana', quantity: 2, price: 6 }
        ],
        total: 52,
        status: 'preparing',
        payment_method: 'Carta',
        notes: '',
        created_at: new Date(Date.now() - 15 * 60000).toISOString()
      },
      {
        id: 3,
        order_number: 'ORD003',
        customer_name: 'Anna Greco',
        customer_phone: '+39 340 5551234',
        delivery_address: 'Via Pola 8, Donnalucata',
        delivery_zone: 'Donnalucata',
        items: [
          { name: 'Parmigiana di Melanzane', quantity: 2, price: 10 },
          { name: 'Sarde a Beccafico', quantity: 1, price: 14 }
        ],
        total: 34,
        status: 'ready',
        payment_method: 'Contanti',
        notes: 'Portare posate di plastica',
        created_at: new Date(Date.now() - 30 * 60000).toISOString()
      }
    ];

    state.orders = mockOrders;

    function render() {
      const app = document.getElementById('app');
      app.innerHTML = `
        ${renderHeader()}
        ${renderTabs()}
        <div class="p-4 pb-8">
          ${state.view === 'orders' ? renderOrders() : ''}
          ${state.view === 'menu' ? renderMenu() : ''}
          ${state.view === 'stats' ? renderStats() : ''}
        </div>
      `;
    }

    function renderHeader() {
      return `
        <div class="bg-orange-500 text-white p-6 sticky top-0 z-10 shadow-lg">
          <div class="flex items-center justify-between mb-3">
            <div>
              <h1 class="text-2xl font-bold">üçΩÔ∏è Portulu</h1>
              <p class="text-orange-100 text-sm">Dashboard Ristoratore</p>
            </div>
            <div class="text-right">
              <div class="text-sm text-orange-100">Benvenuto</div>
              <div class="font-semibold">${state.user.name}</div>
            </div>
          </div>
          <div class="bg-orange-600 rounded-lg p-3">
            <div class="flex justify-between items-center">
              <div>
                <div className="text-sm text-orange-100">Oggi</div>
                <div className="text-2xl font-bold">${state.stats.today.orders} ordini</div>
              </div>
              <div class="text-right">
                <div className="text-sm text-orange-100">Incasso</div>
                <div className="text-2xl font-bold">‚Ç¨${state.stats.today.revenue.toFixed(2)}</div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderTabs() {
      return `
        <div class="bg-white shadow-md sticky top-36 z-10">
          <div class="flex">
            <button 
              onclick="changeView('orders')"
              class="flex-1 py-4 font-semibold transition-colors ${
                state.view === 'orders' 
                  ? 'text-orange-500 border-b-2 border-orange-500' 
                  : 'text-gray-500 hover:text-gray-700'
              }"
            >
              üì¶ Ordini
            </button>
            <button 
              onclick="changeView('menu')"
              class="flex-1 py-4 font-semibold transition-colors ${
                state.view === 'menu' 
                  ? 'text-orange-500 border-b-2 border-orange-500' 
                  : 'text-gray-500 hover:text-gray-700'
              }"
            >
              üìã Menu
            </button>
            <button 
              onclick="changeView('stats')"
              class="flex-1 py-4 font-semibold transition-colors ${
                state.view === 'stats' 
                  ? 'text-orange-500 border-b-2 border-orange-500' 
                  : 'text-gray-500 hover:text-gray-700'
              }"
            >
              üìä Stats
            </button>
          </div>
        </div>
      `;
    }

    function renderOrders() {
      const newOrders = state.orders.filter(o => o.status === 'new');
      const preparingOrders = state.orders.filter(o => o.status === 'preparing');
      const readyOrders = state.orders.filter(o => o.status === 'ready');

      return `
        ${newOrders.length > 0 ? `
          <div class="mb-6">
            <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
              <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm">
                ${newOrders.length}
              </span>
              üîî Nuovi Ordini
            </h2>
            ${newOrders.map(renderOrderCard).join('')}
          </div>
        ` : ''}

        ${preparingOrders.length > 0 ? `
          <div class="mb-6">
            <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
              <span class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-sm">
                ${preparingOrders.length}
              </span>
              üë®‚Äçüç≥ In Preparazione
            </h2>
            ${preparingOrders.map(renderOrderCard).join('')}
          </div>
        ` : ''}

        ${readyOrders.length > 0 ? `
          <div class="mb-6">
            <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
              <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm">
                ${readyOrders.length}
              </span>
              üì¶ Pronti per il Ritiro
            </h2>
            ${readyOrders.map(renderOrderCard).join('')}
          </div>
        ` : ''}

        ${state.orders.length === 0 ? `
          <div class="text-center py-12 text-gray-500">
            <div class="text-6xl mb-4">üì¶</div>
            <p class="text-lg font-semibold">Nessun ordine attivo</p>
            <p class="text-sm mt-2">Gli ordini appariranno qui in tempo reale</p>
          </div>
        ` : ''}
      `;
    }

    function renderOrderCard(order) {
      const statusColors = {
        new: 'bg-blue-100 text-blue-700 border-blue-300',
        preparing: 'bg-yellow-100 text-yellow-700 border-yellow-300',
        ready: 'bg-green-100 text-green-700 border-green-300'
      };

      const statusLabels = {
        new: 'Nuovo',
        preparing: 'In Preparazione',
        ready: 'Pronto'
      };

      const timeAgo = Math.floor((Date.now() - new Date(order.created_at)) / 60000);

      return `
        <div class="bg-white rounded-xl shadow-md p-4 mb-3 border-l-4 border-orange-500">
          <div class="flex justify-between mb-3">
            <div>
              <span class="font-bold text-lg">#${order.order_number}</span>
              <span class="ml-2 text-xs px-2 py-1 rounded-full border ${statusColors[order.status]}">
                ${statusLabels[order.status]}
              </span>
              <span class="ml-2 text-xs text-gray-500">${timeAgo}m fa</span>
            </div>
            <div class="text-right">
              <div class="text-xl font-bold text-orange-500">‚Ç¨${order.total.toFixed(2)}</div>
              <div class="text-xs text-gray-500">${order.payment_method}</div>
            </div>
          </div>

          <div class="border-t pt-3 mb-3">
            <div class="font-semibold text-gray-800 mb-1">${order.customer_name}</div>
            <div class="text-sm text-gray-600 flex items-center gap-1">
              <span>üìç</span>
              ${order.delivery_address}
            </div>
            <div class="text-sm text-gray-600 flex items-center gap-1 mt-1">
              <span>üìû</span>
              <a href="tel:${order.customer_phone}" class="hover:text-orange-500">
                ${order.customer_phone}
              </a>
            </div>
            <div class="text-xs text-gray-500 mt-1">Zona: ${order.delivery_zone}</div>
          </div>

          <div class="bg-gray-50 rounded-lg p-3 mb-3">
            <div class="font-semibold text-sm text-gray-700 mb-2">Articoli:</div>
            ${order.items.map(item => `
              <div class="flex justify-between text-sm mb-1">
                <span class="text-gray-600">${item.quantity}x ${item.name}</span>
                <span class="font-semibold text-gray-800">‚Ç¨${(item.quantity * item.price).toFixed(2)}</span>
              </div>
            `).join('')}
          </div>

          ${order.notes ? `
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-3 text-sm">
              <span class="font-semibold text-yellow-800">üìù Note:</span>
              <span class="text-yellow-700"> ${order.notes}</span>
            </div>
          ` : ''}

          <div class="flex gap-2">
            ${order.status === 'new' ? `
              <button 
                onclick="updateOrderStatus(${order.id}, 'preparing')"
                class="flex-1 bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition"
              >
                ‚úì Accetta Ordine
              </button>
              <button 
                onclick="updateOrderStatus(${order.id}, 'cancelled')"
                class="flex-1 bg-red-500 text-white py-3 rounded-lg font-semibold hover:bg-red-600 transition"
              >
                ‚úó Rifiuta
              </button>
            ` : ''}
            ${order.status === 'preparing' ? `
              <button 
                onclick="updateOrderStatus(${order.id}, 'ready')"
                class="w-full bg-orange-500 text-white py-3 rounded-lg font-semibold hover:bg-orange-600 transition"
              >
                üì¶ Segna come Pronto
              </button>
            ` : ''}
            ${order.status === 'ready' ? `
              <div class="w-full bg-green-100 border-2 border-green-300 text-green-700 py-3 rounded-lg text-center font-semibold">
                ‚úì In attesa del Rider
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    function renderMenu() {
      const categories = [...new Set(state.menuItems.map(item => item.category))];

      return `
        <div class="mb-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-gray-800">üçΩÔ∏è Gestione Menu</h2>
            <button 
              onclick="alert('Funzionalit√† in arrivo!')"
              class="bg-orange-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-orange-600 transition text-sm"
            >
              ‚ûï Aggiungi Piatto
            </button>
          </div>

          ${categories.map(category => `
            <div class="mb-6">
              <h3 class="text-lg font-bold text-gray-700 mb-3 flex items-center gap-2">
                <span class="bg-gray-100 px-3 py-1 rounded-full text-sm">
                  ${state.menuItems.filter(i => i.category === category).length}
                </span>
                ${category}
              </h3>
              <div class="space-y-2">
                ${state.menuItems
                  .filter(item => item.category === category)
                  .map(renderMenuItem)
                  .join('')}
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function renderMenuItem(item) {
      return `
        <div class="bg-white rounded-lg p-4 shadow-sm border-2 ${
          item.available ? 'border-gray-200' : 'border-red-200 bg-red-50'
        }">
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <h4 class="font-semibold text-gray-800">${item.name}</h4>
              <p class="text-orange-500 font-bold mt-1">‚Ç¨${item.price.toFixed(2)}</p>
              ${!item.available ? `
                <span class="text-xs text-red-600 font-semibold mt-1 inline-block">
                  ‚ö†Ô∏è Non disponibile
                </span>
              ` : ''}
            </div>
            <div class="flex items-center gap-2">
              <button
                onclick="toggleAvailability(${item.id})"
                class="px-4 py-2 rounded-lg text-sm font-semibold transition ${
                  item.available
                    ? 'bg-green-100 text-green-700 hover:bg-green-200'
                    : 'bg-gray-200 text-gray-600 hover:bg-gray-300'
                }"
              >
                ${item.available ? '‚úì Attivo' : '‚úó Spento'}
              </button>
              <button
                onclick="alert('Modifica: ${item.name}')"
                class="p-2 hover:bg-gray-100 rounded-lg transition text-gray-600"
              >
                ‚úèÔ∏è
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderStats() {
      return `
        <div class="space-y-4">
          <div class="bg-white rounded-xl shadow-md p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">üìä Statistiche Oggi</h2>
            <div class="grid grid-cols-2 gap-4">
              <div class="text-center p-4 bg-orange-50 rounded-lg">
                <div class="text-4xl font-bold text-orange-500">${state.stats.today.orders}</div>
                <div class="text-sm text-gray-600 mt-2">Ordini</div>
              </div>
              <div class="text-center p-4 bg-green-50 rounded-lg">
                <div class="text-4xl font-bold text-green-500">‚Ç¨${state.stats.today.revenue.toFixed(2)}</div>
                <div class="text-sm text-gray-600 mt-2">Incasso</div>
              </div>
            </div>
            <div class="mt-4 pt-4 border-t text-center">
              <div class="text-sm text-gray-600">Valore medio ordine</div>
              <div class="text-3xl font-bold text-blue-500 mt-1">
                ‚Ç¨${(state.stats.today.revenue / state.stats.today.orders).toFixed(2)}
              </div>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-md p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">üìÖ Questa Settimana</h2>
            <div class="grid grid-cols-2 gap-4">
              <div class="text-center p-4 bg-purple-50 rounded-lg">
                <div class="text-4xl font-bold text-purple-500">${state.stats.week.orders}</div>
                <div class="text-sm text-gray-600 mt-2">Ordini</div>
              </div>
              <div class="text-center p-4 bg-blue-50 rounded-lg">
                <div class="text-4xl font-bold text-blue-500">‚Ç¨${state.stats.week.revenue.toFixed(2)}</div>
                <div class="text-sm text-gray-600 mt-2">Incasso</div>
              </div>
            </div>
          </div>

          <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl shadow-md p-6 text-white">
            <h2 class="text-xl font-bold mb-4">üéØ Performance</h2>
            <div class="space-y-3">
              <div class="flex justify-between items-center">
                <span>Rating Medio</span>
                <span class="font-bold text-2xl">‚≠ê 4.8</span>
              </div>
              <div class="flex justify-between items-center">
                <span>Tempo Medio Preparazione</span>
                <span class="font-bold text-2xl">25 min</span>
              </div>
              <div class="flex justify-between items-center">
                <span>Ordini Completati</span>
                <span class="font-bold text-2xl">1,247</span>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function changeView(view) {
      state.view = view;
      render();
    }

    function updateOrderStatus(orderId, newStatus) {
      const order = state.orders.find(o => o.id === orderId);
      if (order) {
        order.status = newStatus;
        
        // Aggiorna stats
        if (newStatus === 'preparing') {
          playSound('accept');
        }
        
        render();
      }
    }

    function toggleAvailability(itemId) {
      const item = state.menuItems.find(i => i.id === itemId);
      if (item) {
        item.available = !item.available;
        render();
      }
    }

    function playSound(type) {
      // Simula notifica sonora
      console.log('üîî Sound:', type);
    }

    // Init
    render();

    // Simula nuovi ordini ogni 30 secondi (per demo)
    setInterval(() => {
      if (Math.random() > 0.7) {
        console.log('üîî Nuovo ordine simulato!');
        // In produzione, questo arriva da WebSocket
      }
    }, 30000);
  </script>
</body>
</html>
